/**
 * Copyright (c) 2018-2020 aetheryx & Bowser65
 * All Rights Reserved. Licensed under the Porkord License
 * https://powercord.dev/porkord-license
 */

module.exports = async function (code, channelId) {
  const { getModule, FluxDispatcher, constants: { Routes } } = require('powercord/webpack');

  const inviteLocalStore = await getModule([ 'getInvite' ]);
  const inviteRemoteStore = await getModule([ 'resolveInvite' ]);
  const guildsStore = await getModule([ 'getGuilds' ]);
  let invite = inviteLocalStore.getInvite(code);
  if (!invite) {
    // eslint-disable-next-line prefer-destructuring
    invite = (await inviteRemoteStore.resolveInvite(code)).invite;
  }

  if (guildsStore.getGuilds()[invite.guild.id]) {
    const channel = await getModule([ 'getLastSelectedChannelId' ]);
    const router = await getModule([ 'transitionTo' ]);
    // eslint-disable-next-line new-cap
    router.transitionTo(Routes.CHANNEL(invite.guild.id, channelId ? channelId : channel.getChannelId(invite.guild.id)));
  } else {
    const windowManager = await getModule([ 'flashFrame', 'minimize' ]);
    const oldMinimize = windowManager.minimize;
    windowManager.minimize = () => void 0; // Prevent window flickering
    // @todo: transition to channelId if provided
    FluxDispatcher.dispatch({
      type: 'INVITE_MODAL_OPEN',
      context: 'APP',
      invite,
      code
    });
    windowManager.minimize = oldMinimize;
  }
};
